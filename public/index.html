<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arduino Web Serial</title>
  </head>
  <body>
    <div id="app">
      <div id="not-supported">Web Serial is not supported in this browser.</div>
      <div id="supported">
        <div id="not-connected">
          <div>Not Connected</div>
          <button id="connectButton">Connect</button>
        </div>
        <div id="connected">Connected</div>
      </div>
    </div>
    <script type="module">
      // usbProductId: 32823;
      // usbVendorId: 9025;

      // app state
      const hasWebSerial = "serial" in navigator;
      let isConnected = false;

      const $notSupported = document.getElementById("not-supported");
      const $supported = document.getElementById("supported");
      const $notConnected = document.getElementById("not-connected");
      const $connected = document.getElementById("connected");

      const $connectButton = document.getElementById("connectButton");

      const init = async () => {
        displaySupportedState();
        if (!hasWebSerial) return;
        displayConnectionState();

        navigator.serial.addEventListener("connect", (e) => {
          // const port = e.target;
          // const info = port.getInfo();
          console.log("connect", e.target);
        });

        navigator.serial.addEventListener("disconnect", (e) => {
          // const port = e.target;
          // const info = port.getInfo();
          console.log("disconnect", e.target);
        });

        // PORTS
        const ports = await navigator.serial.getPorts();
        console.log(ports);

        $connectButton.addEventListener("click", handleClickConnect);

        // REQUEST PORT
        const port = await navigator.serial.requestPort();
        console.log(port);
      };

      const handleClickConnect = async () => {
        const port = await navigator.serial.requestPort();
        console.log(port);

        const info = port.getInfo();
        console.log(info);

        isConnected = true;
        displayConnectionState();
        await port.open({ baudRate: 9600 });

        // TextEncoderStream sending data string to Arduino
        const textEncoder = new TextEncoderStream();
        const writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
        const writer = textEncoder.writable.getWriter();

        setInterval(async () => {
          const data = {
            r: Math.floor(Math.random() * 255),
            g: Math.floor(Math.random() * 255),
            b: Math.floor(Math.random() * 255),
          };
          console.log(data)
          await writer.write(JSON.stringify(data) = "\n");
        }, 1000);
      };

      const displaySupportedState = () => {
        if (hasWebSerial) {
          $notSupported.style.display = "none";
          $supported.style.display = "block";
        } else {
          $notSupported.style.display = "block";
          $supported.style.display = "none";
        }
      };

      const displayConnectionState = () => {
        if (isConnected) {
          $notConnected.style.display = "none";
          $connected.style.display = "block";
        } else {
          $notConnected.style.display = "block";
          $connected.style.display = "none";
        }
      };

      init();
    </script>
  </body>
</html>
